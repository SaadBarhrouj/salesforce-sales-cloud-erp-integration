name: CD - Deploy to Production

on:
  workflow_dispatch:
    inputs:
      job_id:
        description: 'Job ID de la validation (trouvÃ© dans le commentaire PR)'
        required: true
        type: string
      skip_quick_deploy:
        description: 'Full deploy au lieu de quick deploy ? (si Job ID expirÃ©)'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy-to-production:
    name: ğŸš€ Deploy to Production Org
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Salesforce CLI
        id: cache-sf-cli
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/sf
            ~/.cache/sf
            /usr/local/lib/node_modules/@salesforce
          key: sf-cli-${{ runner.os }}-v2
          restore-keys: |
            sf-cli-${{ runner.os }}-

      - name: Install Salesforce CLI
        if: steps.cache-sf-cli.outputs.cache-hit != 'true'
        run: |
          npm install --global @salesforce/cli
          sf --version

      - name: Verify Salesforce CLI
        if: steps.cache-sf-cli.outputs.cache-hit == 'true'
        run: sf --version

      - name: Authenticate Production Org
        run: |
          echo "${{ secrets.PRODUCTION_AUTH_URL }}" > auth.url
          sf org login sfdx-url \
            --sfdx-url-file auth.url \
            --alias ProductionOrg \
            --set-default
          rm -f auth.url

      - name: ğŸš€ Quick Deploy to Production
        if: ${{ !inputs.skip_quick_deploy }}
        run: |
          echo "âš¡ Quick deploying with Job ID: ${{ inputs.job_id }}"
          sf project deploy quick \
            --job-id ${{ inputs.job_id }} \
            --target-org ProductionOrg \
            --wait 10

      - name: ğŸš€ Full Deploy to Production (Fallback)
        if: ${{ inputs.skip_quick_deploy }}
        run: |
          echo "ğŸ­ Running full deployment (quick deploy skipped)..."
          sf project deploy start \
            --source-dir force-app \
            --target-org ProductionOrg \
            --test-level RunLocalTests \
            --wait 30

      - name: Deployment Summary
        if: success()
        run: |
          echo "============================================"
          echo "âœ… DEPLOYMENT TO PRODUCTION SUCCESSFUL"
          echo "============================================"
          echo "Job ID:      ${{ inputs.job_id }}"
          echo "Quick:       ${{ !inputs.skip_quick_deploy }}"
          echo "Author:      ${{ github.actor }}"
          echo "Timestamp:   $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "============================================"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "============================================"
          echo "âŒ DEPLOYMENT TO PRODUCTION FAILED"
          echo "============================================"
          echo "Check the logs above for details."
          echo "============================================"

      # â”€â”€ ğŸ”” Slack â€” Production Success â†’ @channel â”€â”€
      - name: ğŸ”” Slack â€” Production Deployed Successfully
        if: success()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_DEPLOYMENTS }}
          payload: |
            {
              "text": "âœ… Production dÃ©ployÃ©e avec succÃ¨s â€” <!channel>",
              "attachments": [
                {
                  "color": "#28a745",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸš€ DÃ©ploiement Production rÃ©ussi",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Environnement:*\nğŸ­ Production"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*DÃ©clenchÃ© par:*\n`${{ github.actor }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Job ID:*\n`${{ inputs.job_id }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Mode:*\n${{ inputs.skip_quick_deploy && 'Full Deploy' || 'âš¡ Quick Deploy' }}"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "<!channel> âœ… Nouvelle version dÃ©ployÃ©e en production !"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "ğŸ“‹ Voir le run"
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ğŸ“§ AJOUTÃ‰ : Email toute l'Ã©quipe â€” Nouvelle version prod
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“§ Email â€” Nouvelle version en Production
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          from: ${{ secrets.EMAIL_FROM }}
          to: ${{ secrets.EMAIL_TO_ALL }}
          subject: "ğŸš€ Nouvelle version dÃ©ployÃ©e en Production"
          html_body: |
            <div style="font-family:Arial,sans-serif;max-width:600px;margin:0 auto">
              <div style="background:#28a745;color:#fff;padding:20px;border-radius:8px 8px 0 0">
                <h2 style="margin:0">ğŸš€ Nouvelle version en Production</h2>
              </div>
              <div style="border:1px solid #e0e0e0;border-top:none;padding:20px;border-radius:0 0 8px 8px">
                <p style="font-size:16px">Bonjour Ã  tous,</p>
                <p>Une nouvelle version a Ã©tÃ© dÃ©ployÃ©e avec succÃ¨s en <strong>Production</strong>.</p>
                <table style="width:100%;border-collapse:collapse;margin:15px 0">
                  <tr style="background:#f8f9fa">
                    <td style="padding:10px;font-weight:bold;border:1px solid #dee2e6">DÃ©ployÃ© par</td>
                    <td style="padding:10px;border:1px solid #dee2e6">${{ github.actor }}</td>
                  </tr>
                  <tr>
                    <td style="padding:10px;font-weight:bold;border:1px solid #dee2e6">Job ID</td>
                    <td style="padding:10px;border:1px solid #dee2e6"><code>${{ inputs.job_id }}</code></td>
                  </tr>
                  <tr style="background:#f8f9fa">
                    <td style="padding:10px;font-weight:bold;border:1px solid #dee2e6">Mode</td>
                    <td style="padding:10px;border:1px solid #dee2e6">${{ inputs.skip_quick_deploy && 'Full Deploy' || 'Quick Deploy' }}</td>
                  </tr>
                </table>
                <div style="background:#d4edda;padding:15px;border-radius:4px;margin:15px 0">
                  <p style="margin:0;color:#155724">âœ… Le dÃ©ploiement s'est dÃ©roulÃ© sans erreur.</p>
                </div>
                <p>
                  <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                     style="background:#28a745;color:#fff;padding:10px 20px;text-decoration:none;border-radius:4px;display:inline-block">
                    ğŸ“‹ Voir le dÃ©ploiement
                  </a>
                </p>
              </div>
            </div>

      # â”€â”€ ğŸ”” Slack â€” Production Failure â†’ ALERTE @here â”€â”€
      - name: ğŸ”” Slack â€” ALERTE Production Failed
        if: failure()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_DEPLOYMENTS }}
          payload: |
            {
              "text": "ğŸš¨ ALERTE â€” Ã‰chec du dÃ©ploiement Production â€” <!here>",
              "attachments": [
                {
                  "color": "#dc3545",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸš¨ ALERTE â€” DÃ©ploiement Production Ã‰CHOUÃ‰",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Environnement:*\nğŸ­ Production"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*DÃ©clenchÃ© par:*\n`${{ github.actor }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Job ID:*\n`${{ inputs.job_id }}`"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "<!here> ğŸ”´ *Le dÃ©ploiement en production a Ã©chouÃ© !*\nIntervention immÃ©diate requise."
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "ğŸ”´ VOIR LES LOGS IMMÃ‰DIATEMENT"
                          },
                          "style": "danger",
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ğŸ“§ AJOUTÃ‰ : Email URGENT â€” Ã‰chec dÃ©ploiement Production
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“§ Email â€” ALERTE Ã‰chec Production
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          from: ${{ secrets.EMAIL_FROM }}
          to: ${{ secrets.EMAIL_TO_ALL }}
          subject: "ğŸš¨ URGENT â€” Ã‰chec du dÃ©ploiement Production"
          priority: high
          html_body: |
            <div style="font-family:Arial,sans-serif;max-width:600px;margin:0 auto">
              <div style="background:#dc3545;color:#fff;padding:20px;border-radius:8px 8px 0 0">
                <h2 style="margin:0">ğŸš¨ ALERTE â€” DÃ©ploiement Production Ã‰CHOUÃ‰</h2>
              </div>
              <div style="border:2px solid #dc3545;border-top:none;padding:20px;border-radius:0 0 8px 8px">
                <p style="font-size:16px;color:#dc3545;font-weight:bold">âš ï¸ Intervention immÃ©diate requise</p>
                <table style="width:100%;border-collapse:collapse;margin:15px 0">
                  <tr style="background:#f8f9fa">
                    <td style="padding:10px;font-weight:bold;border:1px solid #dee2e6">DÃ©clenchÃ© par</td>
                    <td style="padding:10px;border:1px solid #dee2e6">${{ github.actor }}</td>
                  </tr>
                  <tr>
                    <td style="padding:10px;font-weight:bold;border:1px solid #dee2e6">Job ID</td>
                    <td style="padding:10px;border:1px solid #dee2e6"><code>${{ inputs.job_id }}</code></td>
                  </tr>
                </table>
                <div style="background:#f8d7da;padding:15px;border-radius:4px;border:1px solid #f5c6cb;margin:15px 0">
                  <p style="margin:0;color:#721c24;font-weight:bold">ğŸ”´ Le dÃ©ploiement en production a Ã©chouÃ©.</p>
                  <p style="margin:10px 0 0;color:#721c24">Veuillez consulter les logs immÃ©diatement.</p>
                </div>
                <p>
                  <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                     style="background:#dc3545;color:#fff;padding:12px 24px;text-decoration:none;border-radius:4px;display:inline-block;font-weight:bold;font-size:16px">
                    ğŸ”´ VOIR LES LOGS
                  </a>
                </p>
              </div>
            </div>
