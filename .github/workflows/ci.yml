name: CI - Pull Request Validation

on:
  pull_request:
    branches:
      - uat
      - main
    paths:
      - 'force-app/**'

jobs:
  # ================================================================
  # JOB 1: Static Code Analysis (PMD)
  # ================================================================
  static-analysis:
    name: üîç Static Code Analysis (PMD)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run PMD Static Analysis
        id: pmd
        uses: pmd/pmd-github-action@v2
        with:
          sourcePath: 'force-app'
          rulesets: 'config/ruleset.xml'
          analyzeModifiedFilesOnly: true
          createGitHubAnnotations: true

      - name: Upload PMD SARIF report
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pmd-report.sarif

      - name: Fail if violations found
        if: steps.pmd.outputs.violations != 0
        run: |
          echo "‚ùå PMD found ${{ steps.pmd.outputs.violations }} violation(s)."
          echo "Please fix the code quality issues before merging."
          exit 1

  # ================================================================
  # JOB 2: Scratch Org Tests (PRs ‚Üí uat only)
  # ================================================================
  scratch-org-test:
    name: üß™ Build & Test (Scratch Org)
    needs: static-analysis
    if: github.base_ref == 'uat'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Salesforce CLI
        id: cache-sf-cli
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/sf
            ~/.cache/sf
            /usr/local/lib/node_modules/@salesforce
          key: sf-cli-${{ runner.os }}-v2
          restore-keys: |
            sf-cli-${{ runner.os }}-

      - name: Install Salesforce CLI
        if: steps.cache-sf-cli.outputs.cache-hit != 'true'
        run: |
          npm install --global @salesforce/cli
          sf --version

      - name: Verify Salesforce CLI
        if: steps.cache-sf-cli.outputs.cache-hit == 'true'
        run: sf --version

      - name: Authenticate Dev Hub
        run: |
          echo "${{ secrets.DEVHUB_AUTH_URL }}" > auth.url
          sf org login sfdx-url \
            --sfdx-url-file auth.url \
            --set-default-dev-hub \
            --alias DevHub
          rm -f auth.url

      - name: Create Scratch Org
        run: |
          sf org create scratch \
            --definition-file config/project-scratch-def.json \
            --alias scratch-ci \
            --set-default \
            --duration-days 1

      - name: Push Source to Scratch Org
        run: sf project deploy start --target-org scratch-ci

      - name: Run Apex Tests
        run: |
          sf apex run test \
            --target-org scratch-ci \
            --wait 15 \
            --result-format human \
            --code-coverage

      - name: Delete Scratch Org
        if: always()
        run: sf org delete scratch --target-org scratch-ci --no-prompt

  # ================================================================
  # JOB 3: Production Validation (validate ‚Üí g√©n√®re Job ID)
  # ================================================================
  validate-production:
    name: üè≠ Validate Against Production
    needs: static-analysis
    if: github.base_ref == 'main'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Salesforce CLI
        id: cache-sf-cli
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/sf
            ~/.cache/sf
            /usr/local/lib/node_modules/@salesforce
          key: sf-cli-${{ runner.os }}-v2
          restore-keys: |
            sf-cli-${{ runner.os }}-

      - name: Install Salesforce CLI
        if: steps.cache-sf-cli.outputs.cache-hit != 'true'
        run: |
          npm install --global @salesforce/cli
          sf --version

      - name: Verify Salesforce CLI
        if: steps.cache-sf-cli.outputs.cache-hit == 'true'
        run: sf --version

      - name: Authenticate Production Org
        run: |
          echo "${{ secrets.PRODUCTION_AUTH_URL }}" > auth.url
          sf org login sfdx-url \
            --sfdx-url-file auth.url \
            --alias ProductionOrg \
            --set-default
          rm -f auth.url

      - name: Validate Deployment (Generates Job ID)
        id: validate
        run: |
          echo "üè≠ Running FULL validation against Production..."
          
          set +e
          RESULT=$(sf project deploy validate \
            --source-dir force-app \
            --target-org ProductionOrg \
            --test-level RunLocalTests \
            --wait 30 \
            --json 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo "$RESULT"
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "============================================"
            echo "‚ùå VALIDATION FAILED"
            echo "============================================"
            
            ERROR_MSG=$(echo "$RESULT" | jq -r '.message // .result.errorMessage // "Unknown error"' 2>/dev/null || echo "Could not parse error")
            echo "Error: $ERROR_MSG"
            
            FAILED_TESTS=$(echo "$RESULT" | jq -r '.result.details.runTestResult.failures[]?.name // empty' 2>/dev/null || true)
            if [ -n "$FAILED_TESTS" ]; then
              echo ""
              echo "Failed tests:"
              echo "$FAILED_TESTS"
            fi
            
            DEPLOY_ERRORS=$(echo "$RESULT" | jq -r '.result.details.componentFailures[]?.problem // empty' 2>/dev/null || true)
            if [ -n "$DEPLOY_ERRORS" ]; then
              echo ""
              echo "Component errors:"
              echo "$DEPLOY_ERRORS"
            fi
            
            JOB_ID=$(echo "$RESULT" | jq -r '.result.id // empty' 2>/dev/null || true)
            if [ -n "$JOB_ID" ]; then
              echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
            fi
            
            echo "============================================"
            exit 1
          fi
          
          JOB_ID=$(echo "$RESULT" | jq -r '.result.id')
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Validation OK ‚Äî Job ID: $JOB_ID"

      - name: Post Job ID to PR
        if: success()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: deploy-job-id
          message: |
            ## üè≠ Production Validation Successful

            | Info | Value |
            |------|-------|
            | **Job ID** | `${{ steps.validate.outputs.job_id }}` |
            | **Status** | ‚úÖ Validated ‚Äî Ready for Quick Deploy |

            ### üìã Deux options pour d√©ployer :
            
            **Option A ‚Äî Salesforce Setup :**
            1. Setup ‚Üí Environments ‚Üí Deploy ‚Üí Deployment Status
            2. Cliquer **Quick Deploy**
            
            **Option B ‚Äî GitHub Actions :**
            1. Onglet Actions ‚Üí **CD - Deploy to Production**
            2. Cliquer **Run workflow**
            3. Coller le Job ID : `${{ steps.validate.outputs.job_id }}`

            > ‚ö†Ô∏è Le Job ID expire apr√®s **10 jours**.

      # ‚îÄ‚îÄ üîî Slack ‚Äî Validation Prod OK ‚îÄ‚îÄ
      - name: üîî Slack ‚Äî Production Validated
        if: success()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_DEPLOYMENTS }}
          payload: |
            {
              "text": "‚úÖ Validation Production r√©ussie ‚Äî PR #${{ github.event.pull_request.number }}",
              "attachments": [
                {
                  "color": "#28a745",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "‚úÖ Validation Production r√©ussie",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Job ID:*\n`${{ steps.validate.outputs.job_id }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*PR:*\n<${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }} ‚Äî ${{ github.event.pull_request.title }}>"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Auteur:*\n`${{ github.actor }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Branche:*\n`${{ github.head_ref }}` ‚Üí `main`"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "üìã *Pr√™t pour Quick Deploy* ‚Üí Salesforce Setup ou GitHub Actions\n\n‚ö†Ô∏è Le Job ID expire apr√®s *10 jours*."
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üîÄ Voir le PR"
                          },
                          "url": "${{ github.event.pull_request.html_url }}"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üìã Voir le run"
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      # ‚îÄ‚îÄ üîî Slack ‚Äî Validation Prod FAILED ‚îÄ‚îÄ
      - name: üîî Slack ‚Äî Production Validation Failed
        if: failure()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_DEPLOYMENTS }}
          payload: |
            {
              "text": "üö® Validation Production √âCHOU√âE ‚Äî PR #${{ github.event.pull_request.number }}",
              "attachments": [
                {
                  "color": "#dc3545",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "üö® Validation Production √âCHOU√âE",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*PR:*\n<${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }} ‚Äî ${{ github.event.pull_request.title }}>"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Auteur:*\n`${{ github.actor }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Branche:*\n`${{ github.head_ref }}` ‚Üí `main`"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "üî¥ Le code ne passe pas la validation production. Intervention requise !"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üî¥ VOIR LES LOGS"
                          },
                          "style": "danger",
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

  # ================================================================
  # JOB 4: PR Comment
  # ================================================================
  pr-comment:
    name: üí¨ PR Results Comment
    needs: [static-analysis, scratch-org-test, validate-production]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      pull-requests: write
    steps:
      - name: Determine overall status
        id: status
        run: |
          ANALYSIS="${{ needs.static-analysis.result }}"
          if [ "$ANALYSIS" = "success" ]; then
            echo "analysis_icon=‚úÖ" >> $GITHUB_OUTPUT
            echo "analysis_text=Passed ‚Äî No violations found" >> $GITHUB_OUTPUT
          elif [ "$ANALYSIS" = "skipped" ]; then
            echo "analysis_icon=‚è≠Ô∏è" >> $GITHUB_OUTPUT
            echo "analysis_text=Skipped" >> $GITHUB_OUTPUT
          else
            echo "analysis_icon=‚ùå" >> $GITHUB_OUTPUT
            echo "analysis_text=Failed ‚Äî Code quality issues detected" >> $GITHUB_OUTPUT
          fi

          TARGET="${{ github.base_ref }}"

          if [ "$TARGET" = "uat" ]; then
            VALIDATION="${{ needs.scratch-org-test.result }}"
            echo "validation_label=üß™ **Apex Tests (Scratch Org)**" >> $GITHUB_OUTPUT
            echo "target_env=UAT" >> $GITHUB_OUTPUT
          else
            VALIDATION="${{ needs.validate-production.result }}"
            echo "validation_label=üè≠ **Production Validation**" >> $GITHUB_OUTPUT
            echo "target_env=Production" >> $GITHUB_OUTPUT
          fi

          if [ "$VALIDATION" = "success" ]; then
            echo "validation_icon=‚úÖ" >> $GITHUB_OUTPUT
            echo "validation_text=Passed" >> $GITHUB_OUTPUT
          elif [ "$VALIDATION" = "skipped" ]; then
            echo "validation_icon=‚è≠Ô∏è" >> $GITHUB_OUTPUT
            echo "validation_text=Skipped (prerequisite failed)" >> $GITHUB_OUTPUT
          else
            echo "validation_icon=‚ùå" >> $GITHUB_OUTPUT
            echo "validation_text=Failed ‚Äî See Actions log for details" >> $GITHUB_OUTPUT
          fi

          if [ "$ANALYSIS" = "success" ] && [ "$VALIDATION" = "success" ]; then
            echo "overall=‚úÖ All checks passed ‚Äî Ready to merge into $TARGET" >> $GITHUB_OUTPUT
          else
            echo "overall=‚ùå Some checks failed ‚Äî Please fix before merging" >> $GITHUB_OUTPUT
          fi

      - name: Post PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: ci-results
          message: |
            ## üîÑ CI Pipeline Results ‚Äî Target: `${{ github.base_ref }}`

            | Check | Status | Details |
            |-------|--------|---------|
            | üîç **Static Analysis (PMD)** | ${{ steps.status.outputs.analysis_icon }} | ${{ steps.status.outputs.analysis_text }} |
            | ${{ steps.status.outputs.validation_label }} | ${{ steps.status.outputs.validation_icon }} | ${{ steps.status.outputs.validation_text }} |

            ### ${{ steps.status.outputs.overall }}

            ---
            *Target environment: **${{ steps.status.outputs.target_env }}***
            <sub>ü§ñ Automated by CI Pipeline ‚Äî <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View full run</a></sub>

  # ================================================================
  # üîî Slack ‚Äî CI Failure ‚Üí @auteur
  # ================================================================
  slack-notify-ci:
    name: üîî Slack ‚Äî CI Failure
    needs: [static-analysis, scratch-org-test, validate-production]
    if: |
      always() && (
        needs.static-analysis.result == 'failure' ||
        needs.scratch-org-test.result == 'failure' ||
        needs.validate-production.result == 'failure'
      )
    runs-on: ubuntu-latest
    steps:
      - name: Resolve Slack mention for PR author
        id: author
        run: |
          MAP='${{ secrets.SLACK_GITHUB_USERS_MAP }}'
          AUTHOR="${{ github.event.pull_request.user.login }}"
          SLACK_ID=""
          if [ -n "$MAP" ] && [ "$MAP" != "" ]; then
            SLACK_ID=$(echo "$MAP" | jq -r --arg user "$AUTHOR" '.[$user] // empty' 2>/dev/null || true)
          fi
          if [ -n "$SLACK_ID" ]; then
            echo "mention=<@$SLACK_ID>" >> $GITHUB_OUTPUT
          else
            echo "mention=\`$AUTHOR\`" >> $GITHUB_OUTPUT
          fi

      - name: Build failure details
        id: details
        run: |
          ANALYSIS="${{ needs.static-analysis.result }}"
          SCRATCH="${{ needs.scratch-org-test.result }}"
          PROD_VAL="${{ needs.validate-production.result }}"
          TARGET="${{ github.base_ref }}"
          FAILURES=""

          if [ "$ANALYSIS" = "failure" ]; then
            FAILURES="${FAILURES}‚Ä¢ üîç Static Analysis (PMD)\n"
          fi
          if [ "$TARGET" = "uat" ] && [ "$SCRATCH" = "failure" ]; then
            FAILURES="${FAILURES}‚Ä¢ üß™ Scratch Org Tests\n"
          fi
          if [ "$TARGET" = "main" ] && [ "$PROD_VAL" = "failure" ]; then
            FAILURES="${FAILURES}‚Ä¢ üè≠ Production Validation\n"
          fi

          echo "failures=$FAILURES" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_CI }}
          payload: |
            {
              "text": "‚ùå CI √©chou√© ‚Äî PR #${{ github.event.pull_request.number }} par ${{ github.event.pull_request.user.login }}",
              "attachments": [
                {
                  "color": "#dc3545",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "‚ùå CI Pipeline Failed",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*PR:*\n<${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }} ‚Äî ${{ github.event.pull_request.title }}>"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Auteur:*\n${{ steps.author.outputs.mention }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Branche cible:*\n`${{ github.base_ref }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Branche source:*\n`${{ github.head_ref }}`"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*Checks √©chou√©s:*\n${{ steps.details.outputs.failures }}"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üìã Voir les logs"
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üîÄ Voir le PR"
                          },
                          "url": "${{ github.event.pull_request.html_url }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
